FROM python:3.10-slim-buster

WORKDIR /app

# First, we'll copy just what we need from the app/api directory
COPY app/api/requirements.txt /app/api/
COPY app/api/tests_unitaires/ /app/api/tests_unitaires/
COPY app/api/main.py /app/api/
COPY app/api/endpoint/ /app/api/endpoint/
COPY app/api/data/ /app/api/data/
COPY app/api/utils/ /app/api/utils/
COPY app/api/static/ /app/api/static/

# Then copy the raw_data directory
COPY app/raw_data/ /app/raw_data/

# Set the working directory to the api folder
WORKDIR /app/api

# Install dependencies
RUN apt-get update && apt-get install -y build-essential
RUN pip install -r requirements.txt
RUN pip install pytest pytest-cov

# Set environment variables for tests
ENV PYTHONPATH=/app
ENV MLFLOW_TRACKING_URI=http://fake-mlflow:5000
ENV MLFLOW_REGISTRY_URI=http://fake-mlflow:5000

# Run the tests
CMD PYTHONPATH=/app pytest -vv tests_unitaires/